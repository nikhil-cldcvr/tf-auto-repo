pipeline {
    agent {
        label 'win'  // Adjust to your Jenkins agent label
    }

    parameters {
        string(name: 'PROJECTS', defaultValue: 'project1:main,project2:master', description: 'Comma-separated list of SonarQube projects with branches (format: project:branch)')
    }

    environment {
        SONAR_URL = "http://34.100.152.207:9000"  // Update to your SonarQube URL
        API_TOKEN = credentials('SONARQUBE_API_TOKEN')  // Secure Jenkins credential
    }

    stages {
        stage('Fetch Coverage Report') {
            steps {
                script {
                    def projects = params.PROJECTS.split(',').collect { it.trim() }
                    def csvReport = new StringBuilder()
                    csvReport.append("Project Name,Branch,DIR,Coverage(%),Average(%)\n")

                    projects.each { projectEntry ->
                        def parts = projectEntry.split(':')
                        def project = parts[0].trim()
                        def branch = parts.length > 1 ? parts[1].trim() : 'default'

                        def encodedProject = java.net.URLEncoder.encode(project, "UTF-8")
                        def encodedBranch = java.net.URLEncoder.encode(branch, "UTF-8")

                        def coverageUrl = "${env.SONAR_URL}/api/measures/component_tree?component=${encodedProject}&metricKeys=coverage&qualifiers=DIR&strategy=children&branch=${encodedBranch}"

                        def jsonFile = "coverage_${project}.json"
                        powershell(script: """
                            try {
                                Invoke-WebRequest -Uri '${coverageUrl}' -Headers @{ Authorization = 'Basic ' + [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes('${env.API_TOKEN}:')) } -OutFile ${jsonFile}
                            } catch {
                                Write-Host 'Failed to fetch coverage data for ${project} on branch ${branch}'
                                exit 1
                            }
                        """)

                        def coverageValues = []
                        if (fileExists(jsonFile) && readFile(jsonFile).trim()) {
                            def jsonResponse = readJSON file: jsonFile

                            if (jsonResponse?.components) {
                                // Add project header row
                                csvReport.append("${project},${branch},,,\n")

                                jsonResponse.components.each { dir ->
                                    def dirName = dir.path ?: dir.name ?: 'N/A'
                                    def coverage = (dir.measures ?: []).find { it.metric == 'coverage' }?.value ?: 'N/A'

                                    if (coverage != 'N/A') {
                                        coverageValues << coverage.toDouble()
                                    }

                                    // Append directory row, leaving "Average(%)" empty for now
                                    csvReport.append(",${branch},${dirName},${coverage}%,\n")
                                }

                                // Calculate and insert average coverage in the first directory row
                                if (coverageValues.size() > 0) {
                                    def avgCoverage = coverageValues.sum() / coverageValues.size()
                                    csvReport = csvReport.toString().replaceFirst(",${branch},", ",${branch},,${String.format('%.2f', avgCoverage)}%\n,${branch},")
                                }
                            } else {
                                echo "No coverage data found for ${project} on branch ${branch}"
                            }
                        } else {
                            catchError(buildResult: 'UNSTABLE') {
                                echo "Failed to fetch coverage data for ${project} on branch ${branch}"
                            }
                        }
                    }

                    writeFile file: 'SonarQube_Coverage_Report.csv', text: csvReport.toString()
                    archiveArtifacts artifacts: 'SonarQube_Coverage_Report.csv'
                }
            }
        }
    }
}
