pipeline {
    agent {
        label 'win'
    }

    parameters {
        string(name: 'JOB_NAME', defaultValue: 'sonar', description: 'Name of the Jenkins job')
        string(name: 'JENKINS_URL', defaultValue: 'http://34.93.109.240:8080', description: 'Jenkins server URL')
        string(name: 'CREDENTIALS_ID', defaultValue: 'nikhil', description: 'Jenkins credentials ID')
    }

    stages {
        stage('Fetch Last Successful Build Timestamp') {
            steps {
                script {
                    // Construct the URL based on parameters
                    def jobName = params.JOB_NAME
                    def jenkinsUrl = params.JENKINS_URL
                    def url = "${jenkinsUrl}/job/${jobName}/lastSuccessfulBuild/api/json?tree=timestamp"

                    // Retrieve credentials securely
                    withCredentials([usernamePassword(credentialsId: params.CREDENTIALS_ID, passwordVariable: 'CREDENTIALS_PASSWORD', usernameVariable: 'CREDENTIALS_USERNAME')]) {
                        // Execute the curl command and store the result
                        def response = bat(script: """
                            curl -u "${CREDENTIALS_USERNAME}:${CREDENTIALS_PASSWORD}" -s "${url}"
                        """, returnStdout: true).trim()

                        // Print the raw response for debugging
                        echo "Raw response: ${response}"

                        // Try parsing the JSON response
                        try {
                            // Clean the response (if necessary)
                            response = response.replaceFirst(/^[^\{]*/, '').trim()

                            // Parse the JSON response
                            def json = new groovy.json.JsonSlurper().parseText(response)
                            def timestamp = json.timestamp

                            // Convert and format the date
                            def date = new Date(timestamp)
                            def formattedDate = date.format('yyyy-MM-dd')

                            // Print the formatted date
                            echo "Formatted date: ${formattedDate}"
                        } catch (Exception e) {
                            // Print error details for troubleshooting
                            error "Failed to parse JSON response: ${e.message}"
                        }
                    }
                }
            }
        }
    }
}
