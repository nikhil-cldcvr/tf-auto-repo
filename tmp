pipeline {
    agent {
        label 'win'
    }

    parameters {
        string(name: 'JOB_NAME', defaultValue: 'Dev/job/date test', description: 'Name of the Jenkins job')
        string(name: 'JENKINS_URL', defaultValue: 'http://34.47.151.236:8080', description: 'Jenkins server URL')
        string(name: 'CREDENTIALS_ID', defaultValue: 'nikhil', description: 'Jenkins credentials ID')
    }

    environment {
        CREDENTIALS_PASSWORD = "11ac03c7511f18fe582113677047edacb4" // Set the credentials password
    }

    stages {
        stage('Fetch Last Successful Build Timestamp') {
            steps {
                script {
                    // Construct the URL based on parameters
                    def jobName = params.JOB_NAME
                    def jenkinsUrl = params.JENKINS_URL
                    def credentialsId = params.CREDENTIALS_ID

                    // Perform encoding to ensure the correct URL
                    def encodedJobName = URLEncoder.encode(jobName, "UTF-8")
                    encodedJobName = encodedJobName.replace('%2F', '/').replace('+', '%20')                    

                    // For Windows BAT, replace '%' with '%%' to escape it
                    def url = "${jenkinsUrl}/job/${encodedJobName}/lastSuccessfulBuild/api/json?tree=timestamp".replace('%', '%%')
                    echo "Constructed URL: ${url}"

                    // Execute the curl command and store the result
                    def response = bat(script: """
                        curl -u "${credentialsId}:${env.CREDENTIALS_PASSWORD}" -s "${url}"
                    """, returnStdout: true).trim()

                    // Clean the response
                    response = response.replaceFirst(/^[^\{]*/, '').trim()

                    // Parse the JSON response
                    def json = new groovy.json.JsonSlurper().parseText(response)
                    def timestamp = json.timestamp

                    // Convert and format the date
                    def date = new Date(timestamp)
                    def formattedDate = date.format('yyyy-MM-dd')

                    // Print the formatted date
                    echo "Formatted date: ${formattedDate}"
                }
            }
        }
    }
}
