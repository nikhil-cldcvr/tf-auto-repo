name: Commit Message Linter

on:
  push:
    branches:
      - main

jobs:
  lint-commit-messages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Validate commit messages
        env:
          COMMIT_REGEX: '^\[JIRA-\d+\] \| (dev|uat|prod|test) \| .+'
        run: |
          echo "Validating commit messages..."
          INVALID_COMMITS=0
          # Iterate through commits in the current push
          for commit in $(git rev-list ${{ github.event.before }}..${{ github.sha }}); do
              COMMIT_MESSAGE=$(git log -1 --pretty=%B $commit)
              echo "Checking commit: $commit"
              echo "Message: $COMMIT_MESSAGE"
              
              if ! [[ "$COMMIT_MESSAGE" =~ $COMMIT_REGEX ]]; then
                  echo "::error::Invalid commit message format for commit $commit: $COMMIT_MESSAGE"
                  INVALID_COMMITS=$((INVALID_COMMITS + 1))
              fi
          done
          
          if [[ $INVALID_COMMITS -gt 0 ]]; then
              echo "::error::One or more commit messages do not follow the required format."
              exit 1
          fi

